---
title: "ESPN_VAR_data"
author: "Oliver Hagger"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R VAR Table Data


```{r message=FALSE, warning=FALSE}
library(rvest)
library(dplyr)
library(stringr)
library(tidyr)
library(readxl)
library(ggplot2)
```

## Set Working Directory

```{r echo=FALSE, message=FALSE, warning=FALSE}
setwd("C:/Users/ohagg/OneDrive - University College London/Desktop/VAR_scraping")
```

```{r eval=FALSE, warning=FALSE, include=TRUE}
setwd("C:~~/VAR_scraping")
```

## Define the URL

```{r}

VAR_PAGE_2020_2021 <- "https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club"
```

## Read the webpage

```{r}
page <- read_html(VAR_PAGE_2020_2021)

team_list <- page %>%
  html_nodes("div.article-body h2") %>%
  html_text() %>%
  gsub("\\s+$", "", .) %>%  # Remove extra spaces at the end
  gsub("[^a-zA-Z]+$", "", .) %>%
  gsub("^Editor's Picks|How to fix VAR.*|The ultimate guide.*|ESPN's .*|Marcotti: .*", "", .) %>%
  unique()
```

```{r}

team_list <- team_list[team_list != ""]

net_score_list <- page %>%
  html_nodes("div.article-body h2") %>%
  html_text() %>%
  gsub("^.* ", "", .) %>%
  head(20)
```

# Extract general statistics for each team

```{r}
team_stats_list <- page %>%
  html_nodes("div.article-body p") %>%
  html_text() %>%
  grep("Overturns: ", ., value = TRUE)
```

# Create a data frame

```{r}
data_df <- data.frame(
  team_name = team_list,
  net_score = net_score_list,
  stats_combined = team_stats_list
)

```

```{r}
# Define stats column mapping
stats_col_mapping <- list(
  c('overturns_total', 'Overturns'),
  c('overturns_rejected', 'Rejected overturns'),
  c('leading_to_goals_for', 'Leading to goals for'),
  c('leading_to_goals_against', 'Leading to goals against'),
  c('disallowed_goals_for', 'Disallowed goals for'),
  c('disallowed_goals_against', 'Disallowed goals against'),
  c('net_goal_score', 'Net goal score'),
  c('subj_decisions_for', 'Subjective decisions for'),
  c('subj_decisions_against', 'Subjective decisions against'),
  c('net_subjective_score', 'Net subjective score'),
  c('penalties_for', 'Penalties for / against'),
  c('penalties_against', 'Penalties for / against'))
```


# Create columns
```{r}
stats_col_list <- sapply(stats_col_mapping, `[`, 1)

for (col in stats_col_list) {
  data_df[[col]] <- 0
}

```

# Update columns based on stats combined information

```{r}
for (i in 1:nrow(data_df)) {
  stats_info <- data_df[i, 'stats_combined']
  stats_lines <- strsplit(stats_info, "(?<=\\d)(?=[A-Z])", perl = TRUE)[[1]]
  
  for (line in stats_lines) {
    key <- strsplit(line, ': ')[[1]][1]
    value <- strsplit(line, ': ')[[1]][2]
    
    for (mapping in stats_col_mapping) {
      if (mapping[[2]] == key) {
        data_df[i, mapping[[1]]] <- value
      }
    }
  }
}
```


# Amend penalties_for and penalties_against columns
```{r}
data_df$penalties_for <- str_extract(data_df$penalties_for, "\\d+")
data_df$penalties_against <- str_extract(data_df$penalties_against, "\\d+")
```

# Add year column and drop stats_combined column
```{r}
data_df$year <- '2019/2020'


data_df <- data_df %>%
  select(-stats_combined)
```

## Read and add VAR decisions for and against
```{r echo=TRUE}

page <- read_html(VAR_PAGE_2020_2021)

VAR_team <- page %>%
  html_nodes("aside.inline.editorial.float-r") %>%
  html_text()
VAR_team <- VAR_team[2:3]

split_lines <- strsplit(VAR_team, "\n")
split_lines <- lapply(split_lines, function(x) x[-1])
print(split_lines)

```

```{r}
decisions_for <- list(split_lines[[1]])
decisions_against <- list(split_lines[[2]])

```

## Initialise empty data frame

```{r}

data_df_for <- data.frame(team = character(0), count = character(0))
data_df_against <- data.frame(team = character(0), count = character(0))

```

## Iterate through each list and extract data

```{r}

for (lines in decisions_for) {
  team <- str_extract(lines, "([\\w\\s&]+)")
  team <- gsub("\\d+", "", team)
  count <- str_extract(lines, "\\d+")
  
  data_df_for <- data_df_for %>%
    add_row(team = team, count = count)
}

for (lines in decisions_against) {
  team <- str_extract(lines, "([\\w\\s&]+)")
  team <- gsub("\\d+", "", team)
  count <- str_extract(lines, "\\d+")
  
  data_df_against <- data_df_against %>%
    add_row(team = team, count = count)
}


```

## Join the data

```{r echo=TRUE}
combined_data <- full_join(data_df_for, data_df_against, by = "team")


colnames(combined_data) <- c("team", "count_for", "count_against")

```

```{r echo=TRUE}
print(combined_data)
```

## Export as a CSV file

```{r}

combined_data$year <- '2019/2020'


year <- '2019_2020'
csv_file_name <- paste0("VAR_decisions", year, ".csv")

write.csv(combined_data, csv_file_name, row.names = T)

```

### Data on the webpage for the 2022/23 season has errors, and some manual errors had to be made

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_sheet_1 <- read_excel("C:/Users/ohagg/OneDrive - University College London/Desktop/VAR_scraping/Team2019_2020.xlsx", sheet = "Team2019_2020")
data_sheet_2 <- read_excel("C:/Users/ohagg/OneDrive - University College London/Desktop/VAR_scraping/Team2019_2020.xlsx", sheet = "Team2020_2021")
data_sheet_3 <- read_excel("C:/Users/ohagg/OneDrive - University College London/Desktop/VAR_scraping/Team2019_2020.xlsx", sheet = "Team2021_2022")
data_sheet_4 <- read_excel("C:/Users/ohagg/OneDrive - University College London/Desktop/VAR_scraping/Team2019_2020.xlsx", sheet = "Team2022_2023")
# Generate graphs

all_data <- bind_rows(data_sheet_1, data_sheet_2, data_sheet_3, data_sheet_4)
```

## Import CSV data and bind

```{r eval=FALSE, warning=FALSE, include=TRUE}
data_sheet_1 <- read_excel("C:/~~/Team2019_2020.xlsx", sheet = "Team2019_2020")
data_sheet_2 <- read_excel("C:/~~/Team2019_2020.xlsx", sheet = "Team2020_2021")
data_sheet_3 <- read_excel("C:/~~/Team2019_2020.xlsx", sheet = "Team2021_2022")
data_sheet_4 <- read_excel("C:/~~/Team2019_2020.xlsx", sheet = "Team2022_2023")
# Generate graphs

all_data <- bind_rows(data_sheet_1, data_sheet_2, data_sheet_3, data_sheet_4)
```

## Set Big 6 Teams

```{r}
big6_teams <- c("Arsenal", "Chelsea", "Liverpool", "Manchester City", "Manchester United", "Tottenham Hotspur")
big6_data <- all_data %>% filter(team_name %in% big6_teams)
rest_of_teams_data <- all_data %>% filter(!team_name %in% big6_teams)
```

## Scatter plot for net score

```{r echo=TRUE}
# Generate scatter plot
ggplot(all_data, aes(x = year, y = net_score, color = team_name %in% big6_teams)) +
  geom_jitter(alpha = 0.45, width = 0.1, size = 3) +
  scale_color_manual(values = c("red", "blue")) +
  labs(title = "Net Score Over Years",
       x = "Year", y = "Net Score",
       color = "Big 6") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank(),  # Remove minor grid lines
        axis.ticks.y = element_blank()) + # Remove y-axis tick marks
        scale_y_continuous(breaks = seq(-8, 8, by = 1))  # Set y-axis tick positions and labels

```

## Bar plot for count for and against

```{r echo=TRUE}
avg_counts <- all_data %>%
  mutate(is_big6 = ifelse(team_name %in% c("Arsenal", "Chelsea", "Liverpool", "Manchester City", "Manchester United", "Tottenham Hotspur"), "Big 6", "Non-Big 6")) %>%
  group_by(year, is_big6) %>%
  summarize(avg_count_for = mean(`Count for`))

ggplot(avg_counts, aes(x = year, y = avg_count_for, fill = is_big6)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Count For by Year and Team Type",
       x = "Year",
       y = "Average Count For") +
  scale_fill_manual(values = c("Big 6" = "blue", "Non-Big 6" = "green")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

avg_counts_against <- all_data %>%
  mutate(is_big6 = ifelse(team_name %in% c("Arsenal", "Chelsea", "Liverpool", "Manchester City", "Manchester United", "Tottenham Hotspur"), "Big 6", "Non-Big 6")) %>%
  group_by(year, is_big6) %>%
  summarize(avg_count_against = mean(`Count against`))

# Generate the bar chart
ggplot(avg_counts_against, aes(x = year, y = avg_count_against, fill = is_big6)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Count Against by Year and Team Type",
       x = "Year",
       y = "Average Count Against") +
  scale_fill_manual(values = c("Big 6" = "blue", "Non-Big 6" = "green")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Average Decisions to Overturn Ratio per League Position 

```{r echo=TRUE}
grouped_data <- all_data %>%
  group_by(Position) %>%
  mutate(decisions_to_overturns = (`Count for` / overturns_total) * 100)

avg_ratios <- grouped_data %>%
  group_by(Position) %>%
  summarize(avg_ratio = mean(decisions_to_overturns, na.rm = TRUE))

ggplot(avg_ratios, aes(x = avg_ratio, y = desc(Position))) +
  geom_point(size = 3) +
  labs(title = "Average Decisions to Overturns Ratio per League Position",
       x = "Average Decisions to Overturns Ratio",
       y = "League Position") +
  theme_minimal()
```